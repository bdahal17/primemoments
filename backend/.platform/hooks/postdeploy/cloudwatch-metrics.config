option_settings:
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

files:
  "/opt/aws/amazon-cloudwatch-agent/etc/custom-cloudwatch-config.json":
    mode: "000644"
    owner: root
    group: root
    content: |
      {
        "metrics": {
          "namespace": "ElasticBeanstalkDockerMetrics",
          "metrics_collected": {
            "mem": {
              "measurement": [
                "used_percent",
                "used",
                "total",
                "cached",
                "free"
              ],
              "metrics_collection_interval": 30
            },
            "processes": {
              "measurement": [
                "cpu_usage",
                "memory_usage"
              ],
              "metrics_collection_interval": 30
            },
            "docker_metrics": {
              "metrics_collect_interval": 60
            }
          },
          "append_dimensions": {
            "InstanceId": "${aws:InstanceId}",
            "EnvironmentName": "${elasticbeanstalk:development}"
          }
        },
        "logs": {
          "logs_collected": {
            "files": {
              "collect_list": [
                {
                  "file_path": "/var/log/docker/containers/*/*.log",
                  "log_group_name": "/aws/elasticbeanstalk/${elasticbeanstalk:development}/docker-container-logs",
                  "log_stream_name": "{instance_id}",
                  "timestamp_format": "%Y-%m-%d %H:%M:%S"
                }
              ]
            }
          }
        }
      }

commands:
  01_update_cloudwatch_agent_config:
    command: |
      # Update CloudWatch agent configuration
      /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
        -a fetch-config \
        -m ec2 \
        -c file:/opt/aws/amazon-cloudwatch-agent/etc/custom-cloudwatch-config.json \
        -s

  02_create_cloudwatch_dashboard:
    command: |
      # Create CloudWatch Dashboard for Memory and Docker Metrics
      aws cloudwatch put-dashboard \
        --dashboard-name "ElasticBeanstalkDockerMetrics-${elasticbeanstalk:development}" \
        --dashboard-body '{
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "ElasticBeanstalkDockerMetrics", "mem_used_percent", "InstanceId", "${aws:InstanceId}" ],
                  [ ".", "mem_used", ".", "." ],
                  [ ".", "mem_total", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Memory Usage"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "ElasticBeanstalkDockerMetrics", "processes_cpu_usage", "InstanceId", "${aws:InstanceId}" ],
                  [ ".", "processes_memory_usage", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Process Metrics"
              }
            }
          ]
        }'
    test: test -n "${AWS_ACCESS_KEY_ID}"  # Only run if AWS credentials are available

option_settings:
  aws:elasticbeanstalk:application:environment:
    CLOUDWATCH_CUSTOM_METRICS_ENABLED: true
